<main id="reservation_page">
  <section class="reservation-card block_white">
    <div class="reservation-header">
      <button class="btn btn-back" (click)="goBack()">â† Revenir</button>
      <h2>Mes rÃ©servations</h2>
      <div class="header-stats">
        <span class="stat-badge">{{ reservations.length }} rÃ©servation(s)</span>
      </div>
    </div>

    <!-- State: No Reservations -->
    <div *ngIf="reservations.length === 0" class="no-reservations">
      <div class="empty-icon">ğŸ“…</div>
      <h3>Aucune rÃ©servation</h3>
      <p>Vous n'avez pas encore de rÃ©servations. Allez rÃ©server un jeu !</p>
    </div>

    <!-- State: Table of Reservations -->
    <div *ngIf="reservations.length > 0" class="table-container">
      <table class="reservation-table">
        <thead>
          <tr>
            <th class="col-date">Date dÃ©but</th>
            <th class="col-date">Date fin</th>
            <th class="col-game">Jeu</th>
            <th class="col-table">Table</th>
            <th class="col-status">Statut</th>
            <th class="col-avis">Titre Avis</th>
            <th class="col-comment">Commentaire</th>
            <th class="col-rating">Note</th>
            <th class="col-action">Action</th>
          </tr>
        </thead>

        <tbody>
          <tr
            *ngFor="let r of reservations; let i = index"
            [class.odd]="i % 2 === 1"
            [class.highlight]="isReservationHighlighted(r)"
          >
            <!-- Date DÃ©but -->
            <td class="col-date">
              <span class="date-badge">
                {{ r.datetimeDebut | date : 'dd/MM/yyyy' }}
              </span>
              <span class="time-badge">
                {{ r.datetimeDebut | date : 'HH:mm' }}
              </span>
            </td>

            <!-- Date Fin -->
            <td class="col-date">
              <span class="date-badge">
                {{ r.datetimeFin | date : 'dd/MM/yyyy' }}
              </span>
              <span class="time-badge">
                {{ r.datetimeFin | date : 'HH:mm' }}
              </span>
            </td>

            <!-- Jeu -->
            <td class="col-game">
              <span class="game-name">{{ r.jeu?.nom }}</span>
            </td>

            <!-- Table -->
            <td class="col-table">
              <span class="table-badge">{{ r.tableJeu?.nomTable }}</span>
            </td>

            <!-- Statut (Dynamic Colors) -->
            <td class="col-status">
              <span
                class="status-badge"
                [ngClass]="{
                  'status-confirmed': r.statutReservation === 'confirmÃ©e',
                  'status-cancelled': r.statutReservation === 'annulÃ©e',
                  'status-finished': r.statutReservation === 'terminÃ©e'
                }"
              >
                {{ r.statutReservation }}
              </span>
            </td>

            <!-- Titre Avis -->
            <td class="col-avis">
              <input
                type="text"
                class="input-avis input-titre"
                [(ngModel)]="r.avis!.titre"
                placeholder="Titre..."
                [disabled]="!r.avisModifiable"
                maxlength="100"
              />
              <span class="char-count" *ngIf="r.avisModifiable">
                {{ (r.avis!.titre || '').length }}/100
              </span>
            </td>

            <!-- Commentaire -->
            <td class="col-comment">
              <textarea
                class="input-avis input-comment"
                [(ngModel)]="r.avis!.commentaire"
                placeholder="Votre avis..."
                [disabled]="!r.avisModifiable"
                rows="2"
                maxlength="500"
              ></textarea>
              <span class="char-count" *ngIf="r.avisModifiable">
                {{ (r.avis!.commentaire || '').length }}/500
              </span>
            </td>

            <!-- Note (Ã‰toiles) -->
            <td class="col-rating">
              <div
                class="note-etoiles"
                [class.disabled]="!r.avisModifiable"
                [title]="r.avisModifiable ? 'Cliquez pour noter' : 'Non modifiable'"
              >
                <span
                  *ngFor="let star of [1, 2, 3, 4, 5]"
                  (click)="setRating(r, star)"
                  [class.active]="r.avis!.note >= star"
                  [class.hover]="!r.avisModifiable"
                  class="star"
                >
                  â˜…
                </span>
              </div>
              <span class="rating-text" *ngIf="r.avis!.note > 0"> {{ r.avis!.note }}/5 </span>
            </td>

            <!-- ACTION COLUMN (Validate + Cancel) -->
            <td class="col-action">
              <!-- 1. Validate Review (Only if modifiable) -->
              <button
                class="btn btn-validate"
                (click)="saveAvis(r)"
                *ngIf="r.avisModifiable"
                title="Valider l'avis"
                style="margin-bottom: 5px; display: block; width: 100%"
              >
                âœ”ï¸ Valider
              </button>
              <!-- Icon if Review Validated -->
              <div
                class="status-icon"
                *ngIf="!r.avisModifiable && r.statutReservation === 'terminÃ©e'"
                title="Avis publiÃ©"
              >
                âœ”ï¸ Avis PubliÃ©
              </div>

              <!-- 2. CANCEL BUTTON (Only if confirmed) -->
              <button
                class="btn btn-cancel"
                (click)="cancelReservation(r)"
                *ngIf="r.statutReservation === 'confirmÃ©e'"
                title="Annuler la rÃ©servation"
              >
                âŒ Annuler
              </button>

              <!-- Label if Cancelled -->
              <span *ngIf="r.statutReservation === 'annulÃ©e'" class="label-cancelled">
                ğŸš« AnnulÃ©e
              </span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
</main>
